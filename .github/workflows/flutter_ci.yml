name: Flutter CI

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze_and_test:
    name: ğŸ” Analyze & Test
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@f2c4f6686ca8e8d6e6d0f28410eeef506ed66aff
        with:
          channel: stable
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ¨ Check formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ” Analyze code
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: ğŸ§ª Run tests
        run: flutter test --coverage

      - name: ğŸ“Š Coverage reporting & gate
        run: |
          # --- Raw coverage ---
          RAW=$(awk -F: '/^LF:/{lf+=$2}/^LH:/{lh+=$2} END{if(lf>0) printf("%.1f", (lh/lf)*100); else print "0.0"}' coverage/lcov.info)
          echo "TOTAL_COVERAGE_RAW=${RAW}%"

          # --- Filtered coverage (exclude only generated code) ---
          awk '
            /^SF:/ {
              skip = 0
              if ($0 ~ /\/l10n\//) skip = 1
              if ($0 ~ /\.g\.dart/) skip = 1
              if ($0 ~ /\.freezed\.dart/) skip = 1
              if ($0 ~ /\.gr\.dart/) skip = 1
            }
            !skip { print }
          ' coverage/lcov.info > coverage/lcov_filtered.info

          FILTERED=$(awk -F: '/^LF:/{lf+=$2}/^LH:/{lh+=$2} END{if(lf>0) printf("%.1f", (lh/lf)*100); else print "0.0"}' coverage/lcov_filtered.info)
          echo "TOTAL_COVERAGE_FILTERED=${FILTERED}%"

          # --- Gate: 50% filtered ---
          # Ramp plan: 50% now â†’ 55% next sprint â†’ 60% target
          awk "BEGIN {exit !(${FILTERED} >= 50.0)}" || {
            echo "::error::Filtered coverage ${FILTERED}% is below 50.0% threshold"
            exit 1
          }

      - name: ğŸ“¦ Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage/lcov.info
            coverage/lcov_filtered.info
          retention-days: 14

  build_android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: analyze_and_test
    if: github.event_name == 'push'

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@f2c4f6686ca8e8d6e6d0f28410eeef506ed66aff
        with:
          channel: stable
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Validate Android release signing secrets
        run: |
          test -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" || { echo "::error::Missing ANDROID_KEYSTORE_BASE64"; exit 1; }
          test -n "${{ secrets.KEYSTORE_PASSWORD }}" || { echo "::error::Missing KEYSTORE_PASSWORD"; exit 1; }
          test -n "${{ secrets.KEY_ALIAS }}" || { echo "::error::Missing KEY_ALIAS"; exit 1; }
          test -n "${{ secrets.KEY_PASSWORD }}" || { echo "::error::Missing KEY_PASSWORD"; exit 1; }

      - name: ğŸ” Decode Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > "${RUNNER_TEMP}/release-keystore.jks"
          {
            echo "KEYSTORE_PATH=${RUNNER_TEMP}/release-keystore.jks"
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}"
            echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}"
            echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}"
          } >> "$GITHUB_ENV"

      - name: ğŸš« Block Telegram token injection in release builds
        run: |
          test -z "${TELEGRAM_BOT_TOKEN:-}" || { echo "::error::TELEGRAM_BOT_TOKEN must not be set for release/profile builds"; exit 1; }
          test -z "${TELEGRAM_CHAT_ID:-}" || { echo "::error::TELEGRAM_CHAT_ID must not be set for release/profile builds"; exit 1; }

      # Cache Gradle for faster builds
      - name: ğŸ—„ï¸ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: ğŸ—ï¸ Build Release APK
        run: |
          flutter build apk --release \
            --dart-define=ENABLE_ERROR_REPORTING=true \
            --dart-define=ENABLE_DIAGNOSTIC_EVENTS=false

      - name: ğŸ—ï¸ Build Release AAB
        run: |
          flutter build appbundle --release \
            --dart-define=ENABLE_ERROR_REPORTING=true \
            --dart-define=ENABLE_DIAGNOSTIC_EVENTS=false

      - name: ğŸ“¦ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 14

      - name: ğŸ“¦ Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 14

  build_ios:
    name: ğŸ Build iOS
    runs-on: macos-latest
    needs: analyze_and_test
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'

    permissions:
      contents: read

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@f2c4f6686ca8e8d6e6d0f28410eeef506ed66aff
        with:
          channel: stable
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸš« Block Telegram token injection in release builds
        run: |
          test -z "${TELEGRAM_BOT_TOKEN:-}" || { echo "::error::TELEGRAM_BOT_TOKEN must not be set for release/profile builds"; exit 1; }
          test -z "${TELEGRAM_CHAT_ID:-}" || { echo "::error::TELEGRAM_CHAT_ID must not be set for release/profile builds"; exit 1; }

      # Cache CocoaPods for faster builds
      - name: ğŸ—„ï¸ Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: pods-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-

      - name: ğŸ“± Build iOS (no codesign)
        run: |
          flutter build ios --release --no-codesign \
            --dart-define=ENABLE_ERROR_REPORTING=true \
            --dart-define=ENABLE_DIAGNOSTIC_EVENTS=false

      - name: ğŸ“¦ Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 14
